---
title: "Quantifying interactions between economics of climate change, the rest of economics and other disciplines"
author: ""
date: "`r format(Sys.time(), '%d/%m/%y')`"
output: html_document
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r setup, include=FALSE}
# Clean memory 
rm(list=ls())
gc()

# Load package
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, data.table, here, lubridate, ggmap, geosphere, stringr, gender, genderdata)

# List directories 
dir <- list()
dir$root <- here()
dir$figures <- here(dir$root, "Figures")
dir$tables <- here(dir$root, "Tables")
dir$raw.data <- here(dir$root, "Raw_data")
dir$prep.data <- here(dir$root, "Prepared_data")
# Create non existing directories
lapply(dir, function(i) dir.create(i, recursive = T, showWarnings = F))
```

# Preliminary data analysis

## Authorship data: gender and affiliation
Affiliation data `C1`and `RP` variables. We'd like to identify each countries in which authors of the articles are affiliated. Thus, we'd like to create a variable "country" which list each country referenced in the `C1`and `RP`variables. 

You can focus on climate related articles

```{r}
### First load data:
load(here(dir$prep.data,"Corpus_Short.Rdata"))
```

## Gender 

Creation of new columns for each author and for each article : separation of the column "AF" into several columns. New columns are entitled "author_" and goes from 1 to 10 (1 if there is only 1 author and 10 if there are 10 authors)

Step 1 : count the number of authors maximum (count the number of semicolon in each obs of the AF variable) : ici je ne comprends pas trop ce qui se passe car il semble y avoir un nombre très important d'articles avec plus de 10 auteurs (1999 je crois) mais lorsque nous créons la colonne 'author_11" qui répertorie ces articles et le nom des auteurs et que nous l'affichons (cf dernière ligne de code), il y a seulement quelques auteurs par lignes (et non pas + de 10)

```{r}
# Creation of a new column to count the number of authors per article 
Corpus.Short$nb_authors <- str_count(Corpus.Short$AF, ";") + 1

# Display the 1000 largest values in the "nb_authors" column to see the maximum number of authors in the database 
top_1000_max_authors <- head(sort(Corpus.Short$nb_authors, decreasing = TRUE), 1000)
print(top_1000_max_authors)

# Creation of the columns for the authors. 
# The last one (author_11) contains names of the authors for articles that have more than 10 authors (roughly 1500)

Corpus.Short <- Corpus.Short %>%
  separate(col = AF, into = paste0("author_", 1:11), sep = ";", remove = FALSE, extra = "drop") %>%
  mutate(author_11 = ifelse(nb_authors > 10, paste(author_11, author_10, sep = ";"), NA_character_)) %>%
  select(-nb_authors)

# Display lines of the colomn "author_11" that do not contain missing values to see if it works

Corpus.Short %>%
  filter(!is.na(author_11)) %>%
  select(author_11)
```

Step 2 : Checks and cleaning 

Check to see if there are only missing values in one of the new column created

```{r}
results<- vector("logical", length = 11)

for (i in 1:11) {
  results[i] <- all(is.na(Corpus.Short[[paste0("author_", i)]]))
}

print(results)
```

Delete white spaces in the new columns created

```{r}
for (i in 1:11) {
  Corpus.Short[[paste0("author_", i)]] <- str_trim(Corpus.Short[[paste0("author_", i)]])
}
```

Delete parenthesis and figures in each columns created 

```{r}
for (i in 1:11) {
  Corpus.Short[[paste0("author_", i)]] <- gsub("\\s*\\([^\\)]+\\)", "", Corpus.Short[[paste0("author_", i)]])
}
```

Create a column for each last name and first name 

```{r}
for (i in 1:11) {
  Corpus.Short <- Corpus.Short %>%
    separate(col = paste0("author_", i), into = c(paste0("l_name_", i), paste0("f_name_", i)), sep = ",", remove = FALSE, extra = "drop")
}
```

Delete white spaces in columns f_name 

```{r}
for (i in 1:11) {
  Corpus.Short[[paste0("f_name_", i)]] <- str_trim(Corpus.Short[[paste0("f_name_", i)]])
}
```

Step 3 : Dataframe for probabilities for gender 

```{r}
get_gender_prob <- function(first_name) 
  {
  gender(first_name)
}

gender_proba <- lapply(Corpus.Short[, grepl("^f_name_", colnames(Corpus.Short))], get_gender_prob)

gender_proba_df <- do.call(rbind, gender_proba)
```


```{r}
# table(Corpus$CC)
table(Corpus.Short$CC)
```

## Citation data

### Clean citation data
Prepare citation data. We want to create a database, where for each article (one raw in `Corpus`), we have a data frame with its cited articles. (one raw by references). We want to separate information on the authors of the cited articles, the title of the article, the year of publication, and the journal. 

First work with one of the datasource: let's say Wos.

```{r}
gc()
load(here(dir$prep.data,"Wos_Short.Rdata"))
head(Wos.Econ.Short$CR)
```

Test

```{r}
table(is.na(Wos.Econ.Short$CR))
```

Test 2

```{r}
table(is.na(Wos.Econ.Short$CR), Wos.Econ.Short$PY)
```
